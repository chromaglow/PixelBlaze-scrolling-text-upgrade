/*
  Advanced Marquee Pattern v6
  
  Features:
  - Sizes: Small, Med, Large, Full
  - Colors: Solid, Rainbow, Gradient
  - Gradient: 3 Full Color Pickers
*/

/* CONFIGURATION */
var message = [
    72, 101, 108, 108, 111, 32, // Hello 
    87, 111, 114, 108, 100, 33  // World!
] // Modify this via Helper Tool

/* ===========================
   UI CONTROLS
   =========================== */

export var speedVar = 1
export function sliderSpeed(v) {
    speedVar = 0.5 + (v * 4)
}

// --- SIZES ---
export var scale = 1
export function triggerSizeSmall() { scale = 1 }
export function triggerSizeMedium() { scale = 2 }
export function triggerSizeLarge() { scale = 3 }
export function triggerSizeFull() { scale = 27 / 8 }

// --- COLORS ---
export var colorMode = 0 // 0=Solid, 1=Rainbow, 2=Gradient
export function triggerModeSolid() { colorMode = 0 }
export function triggerModeRainbow() { colorMode = 1 }
export function triggerModeGradient() { colorMode = 2 }

// Solid Color Picker
export var mainHue = 0
export var mainSat = 1
export function hsvPickerColor(h, s, v) {
    mainHue = h
    mainSat = s
}

// Gradient Pickers (Top, Mid, Bottom)
export var gTopH = 0, gTopS = 1, gTopV = 1
export var gMidH = 0.33, gMidS = 1, gMidV = 1
export var gBotH = 0.66, gBotS = 1, gBotV = 1

export function hsvPickerGradTop(h, s, v) { gTopH = h; gTopS = s; gTopV = v }
export function hsvPickerGradMid(h, s, v) { gMidH = h; gMidS = s; gMidV = v }
export function hsvPickerGradBot(h, s, v) { gBotH = h; gBotS = s; gBotV = v }


/* ===========================
   LOGIC & RENDERING
   =========================== */

var charRows = 8
var fontCharCount = 128
var fontBitmap = array(charRows)
for (row = 0; row < charRows; row++) fontBitmap[row] = array(fontCharCount / 4)

var character = array(charRows)
var matrixRows = 27
var matrixCols = 21

var renderBuffer = array(matrixRows)
for (row = 0; row < matrixRows; row++) renderBuffer[row] = array(matrixCols)

var scrollPos = 0

export function beforeRender(delta) {
    scrollPos += (delta / 50) * speedVar

    // Clear
    for (r = 0; r < matrixRows; r++) {
        for (c = 0; c < matrixCols; c++) renderBuffer[r][c] = 0
    }

    // Draw to buffer
    var totalW = message.length * 8
    var spaceW = matrixCols
    var loopW = totalW + spaceW
    var shift = scrollPos

    var startRow = floor((matrixRows - 8) / 2)

    for (var i = 0; i < message.length; i++) {
        var charBaseX = (i * 8) - shift
        var offset = charBaseX % loopW
        if (offset < -totalW) offset += loopW

        if (offset > -8 && offset < matrixCols) {
            drawChar(message[i], startRow, floor(offset))
        }
    }
}

function drawChar(ascii, rOffset, cOffset) {
    fetchCharacter(ascii)
    for (var row = 0; row < 8; row++) {
        var bits = character[row]
        for (var col = 0; col < 8; col++) {
            if ((bits >> (7 - col)) & 1) {
                var targetR = rOffset + row
                var targetC = cOffset + col
                if (targetR >= 0 && targetR < matrixRows &&
                    targetC >= 0 && targetC < matrixCols) {
                    renderBuffer[targetR][targetC] = 1
                }
            }
        }
    }
}

export function render2D(index, x, y) {
    // Zoom Logic
    var cx = (x - 0.5) / scale + 0.5
    var cy = (y - 0.5) / scale + 0.5

    // Flip Y
    var r = floor(cy * (matrixRows - 0.001))
    r = (matrixRows - 1) - r

    var c = floor(cx * (matrixCols - 0.001))

    if (r >= 0 && r < matrixRows && c >= 0 && c < matrixCols) {
        if (renderBuffer[r][c] > 0) {
            if (colorMode == 0) {
                hsv(mainHue, mainSat, 1)
            }
            else if (colorMode == 1) {
                // Rainbow
                hsv(x + time(0.1), 1, 1)
            }
            else {
                // Gradient (Top -> Mid -> Bot)
                // y is 0..1 (before flip? Engine provides 0..1).
                // render2D(index, x, y) provides coordinates.
                // We want gradient to follow SCREEN Y, not buffer Y.
                // So we use 'y' directly.
                var h, s, v
                if (y < 0.5) {
                    // Top to Mid
                    var t = y * 2
                    h = mix(gTopH, gMidH, t)
                    s = mix(gTopS, gMidS, t)
                    v = mix(gTopV, gMidV, t)
                } else {
                    // Mid to Bot
                    var t = (y - 0.5) * 2
                    h = mix(gMidH, gBotH, t)
                    s = mix(gMidS, gBotS, t)
                    v = mix(gMidV, gBotV, t)
                }
                hsv(h, s, v)
            }
        } else {
            hsv(0, 0, 0)
        }
    } else {
        hsv(0, 0, 0)
    }
}

// --- FONT ENGINE ---
function fetchCharacter(charIndex) {
    var element = floor(charIndex / 4)
    var bank = charIndex % 4
    for (var row = 0; row < charRows; row++) {
        character[row] = unpackByte(row, element, bank)
    }
}
function unpackByte(row, element, bank) {
    var word = fontBitmap[row][element]
    var b = 0
    if (bank > 1) b = word << (8 * (bank - 1))
    else if (bank == 0) b = word >> 8
    else b = word
    return b & 0xFF
}
function storeCharacter(charIndex, r0, r1, r2, r3, r4, r5, r6, r7) {
    var element = floor(charIndex / 4)
    var bank = charIndex % 4
    packByte(0, element, bank, r0)
    packByte(1, element, bank, r1)
    packByte(2, element, bank, r2)
    packByte(3, element, bank, r3)
    packByte(4, element, bank, r4)
    packByte(5, element, bank, r5)
    packByte(6, element, bank, r6)
    packByte(7, element, bank, r7)
}
var byteHolder = array(4)
function packByte(row, element, bank, byte) {
    var original = fontBitmap[row][element]
    for (var i = 0; i < 4; i++) {
        byteHolder[i] = (((original << (i * 8)) & 0xFF00) >> 8) & 0xFF
    }
    byteHolder[bank] = byte
    fontBitmap[row][element] = (byteHolder[0] << 8) + byteHolder[1] + (byteHolder[2] >> 8) + (byteHolder[3] >> 16)
}

/* FONT DATA */
storeCharacter(32, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00)
storeCharacter(33, 0x30, 0x78, 0x78, 0x30, 0x30, 0x00, 0x30, 0x00)
storeCharacter(34, 0x6c, 0x6c, 0x6c, 0x00, 0x00, 0x00, 0x00, 0x00)
storeCharacter(35, 0x6c, 0x6c, 0xfe, 0x6c, 0xfe, 0x6c, 0x6c, 0x00)
storeCharacter(36, 0x30, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x30, 0x00)
storeCharacter(37, 0x00, 0xc6, 0xcc, 0x18, 0x30, 0x66, 0xc6, 0x00)
storeCharacter(38, 0x38, 0x6c, 0x38, 0x76, 0xdc, 0xcc, 0x76, 0x00)
storeCharacter(39, 0x60, 0x60, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00)
storeCharacter(40, 0x18, 0x30, 0x60, 0x60, 0x60, 0x30, 0x18, 0x00)
storeCharacter(41, 0x60, 0x30, 0x18, 0x18, 0x18, 0x30, 0x60, 0x00)
storeCharacter(42, 0x00, 0x66, 0x3c, 0xff, 0x3c, 0x66, 0x00, 0x00)
storeCharacter(43, 0x00, 0x30, 0x30, 0xfc, 0x30, 0x30, 0x00, 0x00)
storeCharacter(44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x60)
storeCharacter(45, 0x00, 0x00, 0x00, 0xfc, 0x00, 0x00, 0x00, 0x00)
storeCharacter(46, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00)
storeCharacter(47, 0x06, 0x0c, 0x18, 0x30, 0x60, 0xc0, 0x80, 0x00)
storeCharacter(48, 0x7c, 0xc6, 0xce, 0xde, 0xf6, 0xe6, 0x7c, 0x00)
storeCharacter(49, 0x30, 0x70, 0x30, 0x30, 0x30, 0x30, 0xfc, 0x00)
storeCharacter(50, 0x78, 0xcc, 0x0c, 0x38, 0x60, 0xc4, 0xfc, 0x00)
storeCharacter(51, 0x78, 0xcc, 0x0c, 0x38, 0x0c, 0xcc, 0x78, 0x00)
storeCharacter(52, 0x1c, 0x3c, 0x6c, 0xcc, 0xfe, 0x0c, 0x1e, 0x00)
storeCharacter(53, 0xfc, 0xc0, 0xf8, 0x0c, 0x0c, 0xcc, 0x78, 0x00)
storeCharacter(54, 0x38, 0x60, 0xc0, 0xf8, 0xcc, 0xcc, 0x78, 0x00)
storeCharacter(55, 0xfc, 0xcc, 0x0c, 0x18, 0x30, 0x30, 0x30, 0x00)
storeCharacter(56, 0x78, 0xcc, 0xcc, 0x78, 0xcc, 0xcc, 0x78, 0x00)
storeCharacter(57, 0x78, 0xcc, 0xcc, 0x7c, 0x0c, 0x18, 0x70, 0x00)
storeCharacter(58, 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00)
storeCharacter(59, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x60, 0x00)
storeCharacter(60, 0x18, 0x30, 0x60, 0xc0, 0x60, 0x30, 0x18, 0x00)
storeCharacter(61, 0x00, 0x00, 0xfc, 0x00, 0x00, 0xfc, 0x00, 0x00)
storeCharacter(62, 0x60, 0x30, 0x18, 0x0c, 0x18, 0x30, 0x60, 0x00)
storeCharacter(63, 0x78, 0xcc, 0x0c, 0x18, 0x30, 0x00, 0x30, 0x00)
storeCharacter(64, 0x7c, 0xc6, 0xde, 0xde, 0xde, 0xc0, 0x78, 0x00)
storeCharacter(65, 0x30, 0x78, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0x00)
storeCharacter(66, 0xfc, 0x66, 0x66, 0x7c, 0x66, 0x66, 0xfc, 0x00)
storeCharacter(67, 0x3c, 0x66, 0xc0, 0xc0, 0xc0, 0x66, 0x3c, 0x00)
storeCharacter(68, 0xf8, 0x6c, 0x66, 0x66, 0x66, 0x6c, 0xf8, 0x00)
storeCharacter(69, 0xfe, 0x62, 0x68, 0x78, 0x68, 0x62, 0xfe, 0x00)
storeCharacter(70, 0xfe, 0x62, 0x68, 0x78, 0x68, 0x60, 0xf0, 0x00)
storeCharacter(71, 0x3c, 0x66, 0xc0, 0xc0, 0xce, 0x66, 0x3e, 0x00)
storeCharacter(72, 0xcc, 0xcc, 0xcc, 0xfc, 0xcc, 0xcc, 0xcc, 0x00)
storeCharacter(73, 0x78, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00)
storeCharacter(74, 0x1e, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78, 0x00)
storeCharacter(75, 0xe6, 0x66, 0x6c, 0x78, 0x6c, 0x66, 0xe6, 0x00)
storeCharacter(76, 0xf0, 0x60, 0x60, 0x60, 0x62, 0x66, 0xfe, 0x00)
storeCharacter(77, 0xc6, 0xee, 0xfe, 0xfe, 0xd6, 0xc6, 0xc6, 0x00)
storeCharacter(78, 0xc6, 0xe6, 0xf6, 0xde, 0xce, 0xc6, 0xc6, 0x00)
storeCharacter(79, 0x38, 0x6c, 0xc6, 0xc6, 0xc6, 0x6c, 0x38, 0x00)
storeCharacter(80, 0xfc, 0x66, 0x66, 0x7c, 0x60, 0x60, 0xf0, 0x00)
storeCharacter(81, 0x78, 0xcc, 0xcc, 0xcc, 0xdc, 0x78, 0x1c, 0x00)
storeCharacter(82, 0xfc, 0x66, 0x66, 0x7c, 0x6c, 0x66, 0xe6, 0x00)
storeCharacter(83, 0x78, 0xcc, 0xe0, 0x70, 0x1c, 0xcc, 0x78, 0x00)
storeCharacter(84, 0xfc, 0xb4, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00)
storeCharacter(85, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0xfc, 0x00)
storeCharacter(86, 0xcc, 0xcc, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00)
storeCharacter(87, 0xc6, 0xc6, 0xc6, 0xd6, 0xfe, 0xee, 0xc6, 0x00)
storeCharacter(88, 0xc6, 0xc6, 0x6c, 0x38, 0x38, 0x6c, 0xc6, 0x00)
storeCharacter(89, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x30, 0x78, 0x00)
storeCharacter(90, 0xfe, 0xc6, 0x8c, 0x18, 0x32, 0x66, 0xfe, 0x00)
storeCharacter(91, 0x78, 0x60, 0x60, 0x60, 0x60, 0x60, 0x78, 0x00)
storeCharacter(92, 0xc0, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x02, 0x00)
storeCharacter(93, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x78, 0x00)
storeCharacter(94, 0x10, 0x38, 0x6c, 0xc6, 0x00, 0x00, 0x00, 0x00)
storeCharacter(95, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff)
storeCharacter(96, 0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00)
storeCharacter(97, 0x00, 0x00, 0x78, 0x0c, 0x7c, 0xcc, 0x76, 0x00)
storeCharacter(98, 0xe0, 0x60, 0x60, 0x7c, 0x66, 0x66, 0xdc, 0x00)
storeCharacter(99, 0x00, 0x00, 0x78, 0xcc, 0xc0, 0xcc, 0x78, 0x00)
storeCharacter(100, 0x1c, 0x0c, 0x0c, 0x7c, 0xcc, 0xcc, 0x76, 0x00)
storeCharacter(101, 0x00, 0x00, 0x78, 0xcc, 0xfc, 0xc0, 0x78, 0x00)
storeCharacter(102, 0x38, 0x6c, 0x60, 0xf0, 0x60, 0x60, 0xf0, 0x00)
storeCharacter(103, 0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0xf8)
storeCharacter(104, 0xe0, 0x60, 0x6c, 0x76, 0x66, 0x66, 0xe6, 0x00)
storeCharacter(105, 0x30, 0x00, 0x70, 0x30, 0x30, 0x30, 0x78, 0x00)
storeCharacter(106, 0x0c, 0x00, 0x0c, 0x0c, 0x0c, 0xcc, 0xcc, 0x78)
storeCharacter(107, 0xe0, 0x60, 0x66, 0x6c, 0x78, 0x6c, 0xe6, 0x00)
storeCharacter(108, 0x70, 0x30, 0x30, 0x30, 0x30, 0x30, 0x78, 0x00)
storeCharacter(109, 0x00, 0x00, 0xcc, 0xfe, 0xfe, 0xd6, 0xc6, 0x00)
storeCharacter(110, 0x00, 0x00, 0xf8, 0xcc, 0xcc, 0xcc, 0xcc, 0x00)
storeCharacter(111, 0x00, 0x00, 0x78, 0xcc, 0xcc, 0xcc, 0x78, 0x00)
storeCharacter(112, 0x00, 0x00, 0xdc, 0x66, 0x66, 0x7c, 0x60, 0xf0)
storeCharacter(113, 0x00, 0x00, 0x76, 0xcc, 0xcc, 0x7c, 0x0c, 0x1e)
storeCharacter(114, 0x00, 0x00, 0xdc, 0x76, 0x66, 0x60, 0xf0, 0x00)
storeCharacter(115, 0x00, 0x00, 0x7c, 0xc0, 0x78, 0x0c, 0xf8, 0x00)
storeCharacter(116, 0x10, 0x30, 0x7c, 0x30, 0x30, 0x34, 0x18, 0x00)
storeCharacter(117, 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0xcc, 0x76, 0x00)
storeCharacter(118, 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0x78, 0x30, 0x00)
storeCharacter(119, 0x00, 0x00, 0xc6, 0xd6, 0xfe, 0xfe, 0x6c, 0x00)
storeCharacter(120, 0x00, 0x00, 0xc6, 0x6c, 0x38, 0x6c, 0xc6, 0x00)
storeCharacter(121, 0x00, 0x00, 0xcc, 0xcc, 0xcc, 0x7c, 0x0c, 0xf8)
storeCharacter(122, 0x00, 0x00, 0xfc, 0x98, 0x30, 0x64, 0xfc, 0x00)
storeCharacter(123, 0x1c, 0x30, 0x30, 0xe0, 0x30, 0x30, 0x1c, 0x00)
storeCharacter(124, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00)
storeCharacter(125, 0xe0, 0x30, 0x30, 0x1c, 0x30, 0x30, 0xe0, 0x00)
storeCharacter(126, 0x76, 0xdc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00)
